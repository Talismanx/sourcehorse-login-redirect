<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SourceHorse Login Redirect</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
    }
    .log {
      margin-top: 20px;
      font-size: 14px;
      color: #333;
      white-space: pre-wrap;
      text-align: left;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h2>Redirecting to SourceHorse...</h2>
  <div class="log" id="log"></div>

  <script>
    const EXT_ID = "kdjnmpafgpneipjegcdaklclfihoafce";
    const logEl = document.getElementById("log");
    function log(msg) {
      console.log(msg);
      logEl.textContent += msg + "\n";
    }

    const hash = window.location.hash || "";
    log("Magic link hash: " + hash);

    function parseHashParams(hash) {
      return hash
        .replace(/^#/, "")
        .split("&")
        .map(kv => kv.split("="))
        .reduce((res, [key, val]) => {
          res[key] = decodeURIComponent(val || "");
          return res;
        }, {});
    }

    if (hash.includes("access_token")) {
      const params = parseHashParams(hash);
      log("Parsed tokens in redirect page:");
      log(JSON.stringify(params, null, 2));

      // ✅ Convert tokens to query params for the extension page
      const query = new URLSearchParams({
        access_token: params["access_token"],
        refresh_token: params["refresh_token"]
      }).toString();

      // ✅ Open extension login page directly
      const extensionUrl = `chrome-extension://${EXT_ID}/login.html?${query}`;
      window.open(extensionUrl, "_blank");

      log("✅ Opened extension login.html with query params. Closing in 2 seconds...");
      setTimeout(() => window.close(), 2000);
    } else {
      log("❌ No access_token in hash. Cannot set session.");
    }
  </script>
</body>
</html>
