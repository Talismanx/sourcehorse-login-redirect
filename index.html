<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SourceHorse Login Redirect</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
    }
    .log {
      margin-top: 20px;
      font-size: 14px;
      color: #333;
      white-space: pre-wrap;
      text-align: left;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h2>Redirecting to SourceHorse...</h2>
  <div class="log" id="log"></div>

  <script>
    const EXT_ID = "kdjnmpafgpneipjegcdaklclfihoafce"; // Update if your production ID changes
    const logEl = document.getElementById("log");
    function log(msg) {
      console.log(msg);
      logEl.textContent += msg + "\n";
    }

    const hash = window.location.hash || "";
    log("Magic link hash: " + hash);

    function parseHashParams(hash) {
      return hash
        .replace(/^#/, "")
        .split("&")
        .map(kv => kv.split("="))
        .reduce((res, [key, val]) => {
          res[key] = decodeURIComponent(val || "");
          return res;
        }, {});
    }

    if (hash.includes("access_token")) {
      const params = parseHashParams(hash);
      log("Parsed tokens in redirect page:");
      log(JSON.stringify(params, null, 2));

      const access_token = params["access_token"];
      const refresh_token = params["refresh_token"];

      // ‚úÖ Send tokens directly to extension background via external messaging
      chrome.runtime.sendMessage(
        EXT_ID,
        { type: "SET_SESSION", access_token, refresh_token },
        (response) => {
          log("üì© Background responded: " + JSON.stringify(response));

          // Open login.html for UI confirmation (optional)
          const extensionUrl = `chrome-extension://${EXT_ID}/login.html`;
          window.open(extensionUrl, "_blank");

          log("‚úÖ Session sent to extension. Closing in 2 seconds...");
          setTimeout(() => window.close(), 2000);
        }
      );
    } else {
      log("‚ùå No access_token in hash. Cannot set session.");
    }
  </script>
</body>
</html>
