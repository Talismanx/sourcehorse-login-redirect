<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SourceHorse Login Redirect</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
    }
    .log {
      margin-top: 20px;
      font-size: 14px;
      color: #333;
      white-space: pre-wrap;
      text-align: left;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h2>Redirecting to SourceHorse...</h2>
  <div class="log" id="log"></div>

  <script>
    const logEl = document.getElementById("log");
    function log(msg) {
      console.log(msg);
      logEl.textContent += msg + "\n";
    }

    // ‚úÖ Grab the Supabase magic link hash
    const hash = window.location.hash || "";
    log("Magic link hash: " + hash);

    // ‚úÖ Parse hash params
    function parseHashParams(hash) {
      return hash
        .replace(/^#/, "")
        .split("&")
        .map(kv => kv.split("="))
        .reduce((res, [key, val]) => {
          res[key] = decodeURIComponent(val || "");
          return res;
        }, {});
    }

    // ‚úÖ If hash contains access_token, parse and send to background
    if (hash.includes("access_token")) {
      const params = parseHashParams(hash);
      log("Parsed tokens in redirect page:");
      log(JSON.stringify(params, null, 2));

      const access_token = params["access_token"];
      const refresh_token = params["refresh_token"];

      // ‚úÖ Send tokens to extension background
      const EXT_ID = "kdjnmpafgpneipjegcdaklclfihoafce"; // Update if needed
      chrome.runtime.sendMessage(
        EXT_ID,
        {
          type: "SET_SESSION",
          access_token,
          refresh_token
        },
        (response) => {
          log("üì© Background responded: " + JSON.stringify(response));

          // ‚úÖ Optionally open extension page for UI feedback
          const extensionUrl = `chrome-extension://${EXT_ID}/login.html`;
          window.open(extensionUrl, "_blank");

          log("‚úÖ Session sent to extension. Closing in 2 seconds...");
          setTimeout(() => window.close(), 9000);
        }
      );
    } else {
      log("‚ùå No access_token in hash. Cannot set session.");
      // Keep page open for debugging
    }
  </script>
</body>
</html>
